{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jack/Desktop/Anthropic-Hackathon/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\n\r\nconst ANTHROPIC_API_URL = 'https://api.anthropic.com/v1/messages';\r\nconst MODEL_NAME = 'claude-3-5-haiku-20241022'; // or another Claude model you can use\r\n\r\ntype ChatMessage = {\r\n  role: 'user' | 'assistant' | 'system';\r\n  content: string;\r\n};\r\n\r\nconst SYSTEM_PROMPT = `\r\nYou are an autism-support AI assistant embedded in a caregiver tool.\r\nBe:\r\n- concrete, gentle, and non-judgmental\r\n- clear when you are guessing, not certain\r\n- very careful not to give medical diagnoses or claim to replace a professional.\r\n\r\nIf the user asks about safety or a crisis, encourage them to seek help from a trusted adult or professional.\r\n`.trim();\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const body = await req.json();\r\n    const { messages } = body as { messages: ChatMessage[] };\r\n\r\n    if (!messages || !Array.isArray(messages) || messages.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Missing \"messages\" array in request body.' },\r\n        { status: 400 },\r\n      );\r\n    }\r\n\r\n    const apiKey = process.env.ANTHROPIC_API_KEY;\r\n    if (!apiKey) {\r\n      console.error('ANTHROPIC_API_KEY is not set on the server for /api/chat');\r\n      return NextResponse.json(\r\n        { error: 'ANTHROPIC_API_KEY is not configured on the server.' },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    // ❗ Only keep user & assistant messages. Ignore any \"system\" roles completely.\r\n    const nonSystemMessages = messages.filter(\r\n      (m) => m.role === 'user' || m.role === 'assistant',\r\n    );\r\n\r\n    const anthropicMessages = nonSystemMessages.map((m) => ({\r\n      role: m.role,\r\n      content: [{ type: 'text' as const, text: m.content }],\r\n    }));\r\n\r\n    const requestBody = {\r\n      model: MODEL_NAME,\r\n      max_tokens: 512,\r\n      system: SYSTEM_PROMPT, // top-level system prompt ✅\r\n      messages: anthropicMessages, // only user & assistant ✅\r\n    };\r\n\r\n    const anthropicResponse = await fetch(ANTHROPIC_API_URL, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'x-api-key': apiKey,\r\n        'anthropic-version': '2023-06-01',\r\n      },\r\n      body: JSON.stringify(requestBody),\r\n    });\r\n\r\n    if (!anthropicResponse.ok) {\r\n      const errorText = await anthropicResponse.text();\r\n      console.error('Anthropic API error (chat):', errorText);\r\n      return NextResponse.json(\r\n        { error: 'Anthropic API error', details: errorText },\r\n        { status: 500 },\r\n      );\r\n    }\r\n\r\n    const data = await anthropicResponse.json();\r\n    const replyText: string = data?.content?.[0]?.text ?? '';\r\n\r\n    return NextResponse.json({ reply: replyText });\r\n  } catch (err) {\r\n    console.error('Error in /api/chat:', err);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error in /api/chat' },\r\n      { status: 500 },\r\n    );\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,oBAAoB;AAC1B,MAAM,aAAa,6BAA6B,sCAAsC;AAOtF,MAAM,gBAAgB,CAAC;;;;;;;;AAQvB,CAAC,CAAC,IAAI;AAEC,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,QAAQ,EAAE,GAAG;QAErB,IAAI,CAAC,YAAY,CAAC,MAAM,OAAO,CAAC,aAAa,SAAS,MAAM,KAAK,GAAG;YAClE,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4C,GACrD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,iBAAiB;QAC5C,IAAI,CAAC,QAAQ;YACX,QAAQ,KAAK,CAAC;YACd,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAqD,GAC9D;gBAAE,QAAQ;YAAI;QAElB;QAEA,+EAA+E;QAC/E,MAAM,oBAAoB,SAAS,MAAM,CACvC,CAAC,IAAM,EAAE,IAAI,KAAK,UAAU,EAAE,IAAI,KAAK;QAGzC,MAAM,oBAAoB,kBAAkB,GAAG,CAAC,CAAC,IAAM,CAAC;gBACtD,MAAM,EAAE,IAAI;gBACZ,SAAS;oBAAC;wBAAE,MAAM;wBAAiB,MAAM,EAAE,OAAO;oBAAC;iBAAE;YACvD,CAAC;QAED,MAAM,cAAc;YAClB,OAAO;YACP,YAAY;YACZ,QAAQ;YACR,UAAU;QACZ;QAEA,MAAM,oBAAoB,MAAM,MAAM,mBAAmB;YACvD,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,aAAa;gBACb,qBAAqB;YACvB;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,IAAI,CAAC,kBAAkB,EAAE,EAAE;YACzB,MAAM,YAAY,MAAM,kBAAkB,IAAI;YAC9C,QAAQ,KAAK,CAAC,+BAA+B;YAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAuB,SAAS;YAAU,GACnD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,kBAAkB,IAAI;QACzC,MAAM,YAAoB,MAAM,SAAS,CAAC,EAAE,EAAE,QAAQ;QAEtD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAU;IAC9C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAqC,GAC9C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}